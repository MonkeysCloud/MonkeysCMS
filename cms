#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * MonkeysCMS CLI Tool
 * Usage: php cms [command]
 */

use App\Core\Kernel;
use MonkeysLegion\Cli\CliKernel;
use MonkeysLegion\Cli\Console\Command;

if (php_sapi_name() !== 'cli') {
    exit;
}

require __DIR__ . '/vendor/autoload.php';

// 1. Bootstrap Application
$rootDir = __DIR__;

// Define ML_BASE_PATH for helpers.php to resolve correctly
if (!defined('ML_BASE_PATH')) {
    define('ML_BASE_PATH', $rootDir);
}

$kernel = new Kernel($rootDir);
$kernel->bootstrap();
$container = $kernel->getContainer();

// 2. Discover Vendor Commands
// Scan vendor/monkeyscloud/*/src/Commands/*.php
$vendorCommands = [];
$vendorDirs = glob($rootDir . '/vendor/monkeyscloud/*/src/Commands');

if ($vendorDirs) {
    foreach ($vendorDirs as $dir) {
        $files = glob($dir . '/*Command.php');
        if (!$files) continue;

        foreach ($files as $file) {
            require_once $file;
        }
    }
}

// 3. Discover App Commands
// Scan app/Cli/Command/*.php
$appCommandDir = $rootDir . '/app/Cli/Command';
if (is_dir($appCommandDir)) {
    $files = glob($appCommandDir . '/*Command.php');
    foreach ($files as $file) {
        require_once $file;
    }
}

// Find all Command subclasses currently declared (MonkeysLegion vendors)
foreach (get_declared_classes() as $class) {
    if (str_starts_with($class, 'MonkeysLegion\\') && 
        str_contains($class, '\\Commands\\') && 
        is_subclass_of($class, Command::class) &&
        !(new ReflectionClass($class))->isAbstract()
    ) {
        $vendorCommands[] = $class;
    }
}

// Find App\Cli\Command classes (use attribute-based discovery)
foreach (get_declared_classes() as $class) {
    if (str_starts_with($class, 'App\\Cli\\Command\\') &&
        !(new ReflectionClass($class))->isAbstract()
    ) {
        // Check if it has the Command attribute
        $ref = new ReflectionClass($class);
        $attrs = $ref->getAttributes(\MonkeysLegion\Cli\Attribute\Command::class);
        if (!empty($attrs)) {
            $vendorCommands[] = $class;
        }
    }
}

// 4. Run CLI Kernel
try {
    $cli = new CliKernel($container, $vendorCommands);
    exit($cli->run($argv));
} catch (\Throwable $e) {
    fwrite(STDERR, "Fatal Error: " . $e->getMessage() . "\n");
    exit(1);
}

